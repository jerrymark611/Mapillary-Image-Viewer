<!DOCTYPE html>
<html>
  <head>
    <title>Search images</title>
    <meta charset="utf-8">

    <style>
      .map {
        height: calc(100vh - 100px); /* 100% of the viewport height - navbar height */

      }

      #panorama {
        height: calc(100vh - 100px); /* 100% of the viewport height - navbar height */

      }

      .nopadding {
        padding: 0 !important;
        margin: 0 !important;
      }

    </style>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">


  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row">
        <div class="col-sm-3 col-md-4 col-lg-4 nopadding" style="background-color:black;">
          <div id="map" class="map"></div>
        </div>

        <div class="col-sm-5 col-md-8 col-lg-8 nopadding" style="background-color:white;">
           <div id="panorama"></div>
        </div>
      </div>
      <h3>Drop GeoJSON to render it on the map</h3>
    </div>

    <!-- 需要 access_token 才能 query, 暫時放在這 -->
    <span id="access_token" style="color:white;">{{ access_token }}</span>

    <script>
      var access_token = document.getElementById('access_token').innerHTML
      const map = new ol.Map({
          target: 'map',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM()
            }),
            new ol.layer.Vector({
              source: new ol.source.Vector({
              }),
              style: new ol.style.Style({
                image: new ol.style.Icon({
                  anchor: [0, 0],
                  anchorXUnits: 'fraction',
                  anchorYUnits: 'pixels',
                  src: 'https://openlayers.org/en/latest/examples/data/icon.png'
                })
              })
            })
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([121, 23.5]),
            zoom: 7
          })
        });
        
        var v = pannellum.viewer('panorama', { 'scenes': [], 'autoLoad': true, 'showFullscreenCtrl': false, 'showZoomCtrl': false });
        v.addScene('test', {
            "type": "equirectangular",
            "panorama": "https://scontent.ftpe3-1.fna.fbcdn.net/m1/v/t6/An_Wo1mwLrV8ZuX9cHPR0LjBF26dRDiwKNHIUS7xdxo9bYLopPCsJtUT9pWX4coWsqnMbeV0XZJcD0oP2YF9E4b7uuyY1yc5O6S-0wkvkOUE-S5kdLBjffEeAGicmJlWx8OMlCQQHTEWilJJ8vUcIA?stp=s2048x1024&ccb=10-5&oh=e1059560357c39d46c2b9689c95a92a7&oe=612F6DD4&_nc_sid=122ab1",
            "compass": true,
            "northOffset": 247.5,
            // "yaw": 0,
            // "northOffset": 247.5
          });
        v.loadScene('test', 0, 0, 60);
        
        // Click map to find closest image to the point
        map.on('singleclick', function (evt) {
            var longitude = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326')[0];
            var latitude = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326')[1];
            
           
            let getJSON = async(url) => {
              let response = await fetch(url);
              let b = await response.json();
              if (b != null){
                v.removeScene('test');
                v.addScene('test', {
                    "type": "equirectangular",
                    "panorama": b
                
              });
              v.loadScene('test', 0, 0, 60);
              }
            }
            getJSON('api?lon=' + longitude + "&lat=" + latitude + "&access_token=" + access_token)
          });


        function wrapLon(value) {
          var worlds = Math.floor((value + 180) / 360);
          return value - (worlds * 360);
        }
        
        // Get boundary of the map
        // map.on('moveend', function (evt) {
        //   var extent = map.getView().calculateExtent(map.getSize());
        //   var bottomLeft = ol.proj.transform(ol.extent.getBottomLeft(extent),
        //       'EPSG:3857', 'EPSG:4326');
        //   var topRight = ol.proj.transform(ol.extent.getTopRight(extent),
        //       'EPSG:3857', 'EPSG:4326');
        // });
        
        // Rendor geojson
        let dragAndDropInteraction;

        function setInteraction() {
          if (dragAndDropInteraction) {
            map.removeInteraction(dragAndDropInteraction);
          }
          dragAndDropInteraction = new ol.interaction.DragAndDrop({
            formatConstructors: [
              ol.format.GeoJSON,
            ],
          });
          dragAndDropInteraction.on('addfeatures', function (event) {
            const vectorSource = new ol.source.Vector({
              features: event.features,
            });
            map.addLayer(
              new ol.layer.Vector({
                source: vectorSource,
              })
            );
            map.getView().fit(vectorSource.getExtent());
          });
          map.addInteraction(dragAndDropInteraction);
        }
        setInteraction();


        const displayFeatureInfo = function (pixel) {
          const features = [];
          map.forEachFeatureAtPixel(pixel, function (feature) {
            features.push(feature);
          });
          if (features.length > 0) {
            const info = [];
            let i, ii;
            
            for (i = 0, ii = features.length; i < ii; ++i) {
              info.push(features[i].get('name'));
            }
            document.getElementById('info').innerHTML = info.join(', ') || '&nbsp';
          } else {
            document.getElementById('info').innerHTML = '&nbsp;';
          }
        };
    </script>
  </body>
</html>